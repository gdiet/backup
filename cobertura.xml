<project name="Cobertura" default="coverage">

  <property name="sources.dir" value="src" />
  <property name="sources.build.dir" value="coverage/bin-src" />
  <property name="sources.instrumented.dir" value="coverage/bin-instrumented" />
  <property name="tests.dir" value="tests" />
  <property name="tests.build.dir" value="coverage/bin-tests" />
  <property name="scala-library.jar" value="${scala.home}/lib/scala-library.jar" />


  <target name="clean">
    <delete dir="coverage" />
  </target>

  
  <target name="init">
  	<fail message="scala.home must be defined in environment" unless="scala.home"/>
  	<fail message="testng.jar must be defined in environment" unless="testng.jar"/>
  	
    <path id="build.classpath">
      <pathelement location="${scala-library.jar}" />
      <!--<pathelement location="${your.path}" />-->
      <pathelement location="${sources.build.dir}" />
    </path>
    
    <path id="tests.build.classpath">
      <path refid="build.classpath"/>
      <pathelement location="${testng.jar}" />
      <fileset dir="testlib" />
    </path>

    <taskdef resource="scala/tools/ant/antlib.xml">
      <classpath>
        <pathelement location="${scala.home}/lib/scala-compiler.jar" />
        <pathelement location="${scala-library.jar}" />
      </classpath>
    </taskdef>

    <property name="cobertura.dir" value="testcoveragelib" />

    <path id="cobertura.classpath">
      <fileset dir="${cobertura.dir}">
        <include name="cobertura.jar" />
        <include name="lib/**/*.jar" />
      </fileset>
    </path>

    <taskdef classpathref="cobertura.classpath" resource="tasks.properties" />

  </target>


  <target name="build-src" depends="init">
    <!-- compile scala and java source -->
    <mkdir dir="${sources.build.dir}" />
    <scalac srcdir="${sources.dir}"
            destdir="${sources.build.dir}"
            classpathref="build.classpath">
      <!--
      <include name="compile/**/*.scala"   />
      <exclude name="forget/**/*.scala"   />
      -->
    </scalac>
    <javac srcdir="${sources.dir}" destdir="${sources.build.dir}">
      <classpath>
        <pathelement location="${sources.build.dir}" />
      </classpath>
    </javac>
  </target>


  <target name="build-test" depends="build-src">
    <!-- compile scala and java source -->
    <mkdir dir="${tests.build.dir}" />
    <scalac srcdir="${tests.dir}"
            destdir="${tests.build.dir}"
            classpathref="tests.build.classpath">
      <!--
      <include name="compile/**/*.scala"   />
      <exclude name="forget/**/*.scala"   />
      -->
    </scalac>
  </target>


  <target name="coverage" depends="clean,build-test">
    <cobertura-instrument datafile="coverage/cobertura.ser" todir="${sources.instrumented.dir}">
      <fileset dir="${sources.build.dir}" />
    </cobertura-instrument>
    
    <taskdef resource="testngtasks" classpath="${testng.jar}"/>
    <testng>
      <sysproperty key="net.sourceforge.cobertura.datafile" file="coverage/cobertura.ser" />
      <classpath>
        <path refid="cobertura.classpath" />
        <pathelement location="${sources.instrumented.dir}" />
        <pathelement location="${sources.build.dir}" />
        <pathelement location="${tests.build.dir}" />
        <pathelement location="${scala-library.jar}" />
        <fileset dir="testlib" />
      </classpath>
      <xmlfileset file="allTests.xml"/>
    </testng>

    <cobertura-report format="html" datafile="coverage/cobertura.ser" destdir="coverage/report" srcdir="${sources.dir}" />
    
  </target>


</project>
